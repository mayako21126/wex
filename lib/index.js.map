{"version":3,"sources":["../src/index.js"],"names":["testable","target","Wex","x","args","Promise","history","tmp","installModule","self","state","$state","on","bind","off","emit","mapMutations","commit","type","store","n","m","JSON","parse","stringify","_type","_payload","payload","unifyPayload","call","entry","$mutations","$Dev","console","error","setState","event","fn","ctx","_stores","name","$name","i","push","cb","throttle","undefined","slice","Object","prototype","toString","targs","len","length","apply","arguments","splice","setHistory","o","new","old","j","obj","ss","c","getState","y","handler","a","b","oj","setTimeout","Watch","Mutation","$wrappedGetters","create","mutations","res","forEach","ref","key","val","mappedMutation"],"mappings":"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","file":"index.js","sourcesContent":["/**\r\n * no use strict \r\n */\r\n\r\n/**\r\n * Wex 0.3.1\r\n * (c) 2018 Mayako\r\n * 小程序用简易状态机\r\n */\r\n\r\nimport {\r\n  assert,\r\n  deepCopy,\r\n  watchState,\r\n  normalizeMap,\r\n  Watch,\r\n  isObjectValueEqual\r\n} from './utils'\r\n\r\nfunction testable(target) {\r\n\r\n}\r\n\r\n@testable\r\nclass Wex {\r\n  constructor(x) {\r\n\r\n  }\r\n  init(args = {}) {\r\n    assert(typeof Promise !== 'undefined', `Wex requires a Promise polyfill in this browser.`)\r\n    this.history = [];\r\n    this.tmp = ''\r\n    installModule(args, this);\r\n    let self = this;\r\n    return {\r\n      history: this.history,\r\n      get state() {\r\n        return deepCopy(self.$state)\r\n      },\r\n      on: this.on.bind(this),\r\n      off: this.off.bind(this),\r\n      emit: this.emit.bind(this),\r\n      mapMutations: this.mapMutations,\r\n      commit: (type, ...args) => {\r\n        return this.commit(type, {\r\n          store: this,\r\n          args\r\n        })\r\n      }\r\n    }\r\n  }\r\n  // state写入方法\r\n  setState(n, m) {\r\n    // if (typeof m == 'Array' || typeof m == \"object\") {\r\n    //   this.history.push({\r\n    //     name: n,\r\n    //     new: m,\r\n    //     old: this.$state[n]\r\n    //   })\r\n    //   this.emit(n, m);\r\n    //   this.$state[n] = m;\r\n\r\n    // } else {\r\n    //   this.history.push({\r\n    //     name: n,\r\n    //     new: m,\r\n    //     old: this.$state[n]\r\n    //   })\r\n    //   this.emit(n, m);\r\n    //   this.$state[n] = m;\r\n\r\n    // }\r\n    // let tmp = setHistory(n,m,this,Object.assign({}, this.$state[n]))\r\n    let tmp;\r\n    if (typeof m == 'Array' || typeof m == \"object\") {\r\n      tmp = JSON.parse(JSON.stringify(m))\r\n    } else {\r\n      tmp = m\r\n    }\r\n    this.emit(n, tmp);\r\n    this.$state[n] = tmp;\r\n  }\r\n  // commit方法\r\n  commit(_type, _payload) {\r\n    const type = _type;\r\n    const payload = unifyPayload.call(this, _payload);\r\n    const entry = this.$mutations[type]\r\n    if (!entry) {\r\n      if (this.$Dev) {\r\n        console.error(`[wex] unknown mutation type: ${type}`)\r\n      }\r\n      return\r\n    }\r\n    let tmp = payload.store.$state;\r\n    return entry({\r\n      state: tmp,\r\n      setState: payload.store.setState.bind(payload.store),\r\n      commit: payload.store.commit.bind(payload.store),\r\n      args: payload.args\r\n    })\r\n\r\n  }\r\n  // 设置只读属性\r\n  // get state() {\r\n  //   return this._tmp;\r\n  //   // return deepCopy(this.$state)\r\n  // }\r\n  get Mutation() {\r\n    return this.$mutations;\r\n  }\r\n  // 触发自动响应，用于替代computed\r\n  on(event, fn, ctx) {\r\n    if (typeof fn != 'function') {\r\n      console.error('fn must be a function')\r\n      return\r\n    }\r\n    this._stores = this._stores || {};\r\n    // 删除重复的响应事件\r\n    let name = ctx.$name;\r\n    for (var i in this._stores[event]) {\r\n      if (this._stores[event][i].ctx.$name == name) {\r\n        this.off(event, fn)\r\n      }\r\n    }\r\n\r\n    // 添加函数到stores里\r\n    (this._stores[event] = this._stores[event] || []).push({\r\n      cb: fn,\r\n      ctx: ctx\r\n    })\r\n    // 添加之后执行一次触发事件用于更新第一次数据\r\n    this.emit(event, this.$state[event])\r\n  }\r\n  emit(event, ...state) {\r\n    var throttle = false\r\n    this._stores = this._stores || {}\r\n    var store = this._stores[event],\r\n      args\r\n    // 如果触发了不存在的stores，stores必须要提前定义\r\n    if (this.$state[event] == null || this.$state[event] == undefined) {\r\n      console.error(event + ' is undefined')\r\n      return false;\r\n      // this.state[event] =state[0]; \r\n    }\r\n    if (store) {\r\n      store = store.slice(0)\r\n      args = state;\r\n      if (Object.prototype.toString.call(this.tmp) === Object.prototype.toString.call(args)) {\r\n        var type = Object.prototype.toString.call(args);\r\n        if (type == '[object Object]' || type == '[object Array]') {\r\n          throttle = isObjectValueEqual(this.tmp, args);\r\n        } else {\r\n          throttle = this.tmp === args ? true : false;\r\n        }\r\n      }\r\n      this.tmp = args\r\n      var targs = deepCopy(args)\r\n      if(!throttle){\r\n        for (var i = 0, len = store.length; i < len; i++) {\r\n          store[i].cb.apply(store[i].ctx, targs)\r\n        }\r\n      }\r\n    }\r\n  }\r\n  off(event, fn) {\r\n    this._stores = this._stores || {}\r\n    // 删除全部\r\n    if (!arguments.length) {\r\n      this._stores = {}\r\n      return\r\n    }\r\n    var store = this._stores[event]\r\n    if (!store) return\r\n    // 删除同名全部\r\n    if (arguments.length === 1) {\r\n      delete this._stores[event]\r\n      return\r\n    }\r\n    // 删除单独\r\n    var cb\r\n    for (var i = 0, len = store.length; i < len; i++) {\r\n      cb = store[i].cb\r\n      // 判断匿名函数是否一致，因为前面已经判断是否属于同一作用域，所以直接执行tostring()判断\r\n      if (cb.toString() == fn.toString()) {\r\n        store.splice(i, 1)\r\n        break\r\n      }\r\n    }\r\n    return\r\n  }\r\n}\r\n\r\nfunction unifyPayload(...payload) {\r\n  if (!payload[0].store) {\r\n    payload = {\r\n      store: this,\r\n      args: payload\r\n    }\r\n    return payload\r\n  }\r\n  return payload[0]\r\n}\r\n\r\nfunction setHistory(n, m, store, o) {\r\n  if (typeof m == 'Array' || typeof m == \"object\") {\r\n    let tmp = JSON.parse(JSON.stringify(m))\r\n    store.history.push({\r\n      name: n,\r\n      new: tmp,\r\n      old: o\r\n    })\r\n    return tmp;\r\n  } else {\r\n    store.history.push({\r\n      name: n,\r\n      new: m,\r\n      old: o\r\n    })\r\n    return m;\r\n  }\r\n}\r\n\r\nfunction installModule(args, store) {\r\n  // store.$state = args.state;\r\n  // 获取数组,用来监听变化，明天需要抽离history方法\r\n  store.$state = args.state;\r\n\r\n  function j(obj, ss, n, o) {\r\n    var c = obj;\r\n    for (var i = 0; i < ss.length - 1; i++) {\r\n      c = getState(c, ss[i])\r\n    }\r\n    setHistory(ss, n, store, o)\r\n    return c;\r\n  }\r\n\r\n  function getState(x, y) {\r\n    return x[y];\r\n  }\r\n  let handler = (a, b, c) => {\r\n    let oj = j(store.$state, a, b, c);\r\n    // 可能会造成性能问题和不可预知的周期问题，待修改\r\n    setTimeout(function () {\r\n      store.emit(a[0], store.$state[a[0]])\r\n      Watch.call(store, oj, handler)\r\n    }, 0)\r\n\r\n  };\r\n  Watch.call(store, store.$state, handler);\r\n\r\n  store.$mutations = args.Mutation;\r\n  // 不可变结构\r\n  // var x  = im.form(args.state)\r\n  // console.log(x.get('obj'))\r\n  // store.$committig = false\r\n  // store.$actions = Object.create(null)\r\n  store.$wrappedGetters = Object.create(null)\r\n  // store.$subscribers = [];\r\n  store.mapMutations = mapMutations(args.Mutation, store)\r\n}\r\n\r\nfunction mapMutations(mutations, store) {\r\n  var res = {}\r\n  normalizeMap(mutations).forEach(function (ref) {\r\n    var key = ref.key;\r\n    var val = ref.val;\r\n\r\n    res[key] = function mappedMutation() {\r\n      var args = [],\r\n        len = arguments.length;\r\n      while (len--) args[len] = arguments[len]; // 一个数组缓存传入的参数\r\n\r\n      return store.commit(key, {\r\n        store,\r\n        args\r\n      });\r\n    }\r\n  })\r\n  return res\r\n}\r\n\r\n\r\nexport {\r\n  Wex\r\n};"]}